<html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
        <link rel="stylesheet" href="static/css/index.css">
        <script
            src="static/js/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>

    </head>

    <body>
        <div class="" id="stripe">
            <div class="ui container eight column vertically padded stackable grid" id="header">
                <div class="row">
                    <div class="center aligned middle aligned column">
                        <a href="https://www.rle.mit.edu/cb/" target="_blank">
                            <img src="https://www.rle.mit.edu/cb/wp-content/uploads/2019/07/ccrg_logo_transparent_small.2.png"
                            />
                        </a>
                    </div>
                    <div class="ten wide large screen only column"></div>
                    <div class="center aligned middle aligned column">
                    </div>
                    <div class="center aligned middle aligned column">
                    </div>
                </div>
            </div>
        </div>
        <div class="ui container" id="content">

            {% if calc_name == "as" %}
                {% include "partials/calc_as.html" %}
            {% elif calc_name == "rlrvi" %}
                {% include "partials/calc_rlrvi.html" %}
            {% endif %}

            <div id="accept-modal" class="ui modal small">
                <div class="header">Please accept the Terms of Service</div>
                <div class="scrolling content">
                    <p>
                        We are providing this information as a benefit and service in furtherance of our educational mission.
                        The user assumes all responsibility for, and holds the authors and their corresponding institutions harmless from any claims arising out of, its use or misuse of, or inability to use, the risk calculator.
                        Clinical decisions are made based on a comprehensive evaluation of any given patient and the risk calculator represents one tool that should be integrated into a holistic patient evaluation.
                        The authors, and their home institutions, therefore are not not responsible for any treatment or other medical decisions made by users based on information obtained via the risk calculator, and user agrees to indemnify the authors and their home institutions and hold them harmless from any claims arising out of such decisions.
                    </p>
                </div>
                <div class="actions">
                    <div class="ui black deny button">
                        Decline
                    </div>
                    <div class="ui positive right labeled icon button">
                        By proceeding, I accept the Terms and Conditions
                        <i class="checkmark icon"></i>
                    </div>
                </div>
            </div>

        <script type="text/javascript">
            function markButton(event, className) {
                // green to denote, disabled so cannot be clicked again
                $(".button." + className).removeClass("md-green");
                $(".button." + className).removeClass("disabled");
                $(event.target).addClass("md-green");
                $(event.target).addClass("disabled");
            }

            function resetRadioValidity() {
                var rad = document.querySelectorAll('input[type=radio]')
                rad.forEach(function(r) {
                    r.setCustomValidity('')
                });
            }

            function logTarget(event) {
                console.log(event.target.value);
            }

            function navToHomepage() {
                window.location.href = "http://imes.mit.edu/initiatives/mit-mgh/";
            }

            function submitAsync(event, form) {
                event.preventDefault();  // submit form asynchonously
                fetch(form.action, {
                    method: 'post',
                    body: new FormData(form),
                }).then(function(res) {
                    return res.json()
                }).then(function(json) {
                    console.log("RESPONSE")
                    console.log(json)
                    populateResult(json);
                    return json
                })
            }

            function displayPercent(num, key) {
                if (num === undefined || num === null) {
                    return '';
                }
                if (key === 'Unreliability' && typeof num === 'number') {
                    return num.toFixed(2) + ' ';
                }
                if (typeof num === 'string') {
                    // is a column title
                    return num;
                }
                // var rounded = Math.round((num + Number.EPSILON) * 100) / 100;
                return (num * 100).toFixed(2) + "%";
            }

            function resultRow(outcome, risk, lower, upper) {
                var res = "<p class='resultRow'>"

                res += "<span class='resultItem'>" + outcome + "</span>"
                res += "<span class='resultItem'>" + risk + "</span>"

                if (lower != "" && upper != "") {
                    res += "<span class='resultItem'>" + "[" + lower + "&nbsp;&nbsp;&nbsp;" + upper + "]" +"</span>"
                }
                if (lower != "" && upper == "") {
                    res += "<span class='resultItem'>" + lower +"</span>"
                }

                res += "</p>";
                return res;
            }

            function round(num, places=2) {
                return (Math.round(num * (10**places)) / (10**places)).toFixed(places);
            }

            function populateResult(resultData) {
                $('#result').removeClass('hidden');
                var res = ""
                Object.entries(resultData).forEach(function(row) {
                    var key = row[0]
                    var val = row[1]
                    if (key.includes("subgroup in which")) {
                        res += resultRow(key + " " + round(val[0],4) + ".");
                    } else {
                        res += resultRow(key, displayPercent(val[0], key), displayPercent(val[1], key), displayPercent(val[2], key))
                    }
                })
                $('#result').html(res)
            }

            // control calculator displays
            function displayCalc(calcId) {
                $('.calc').addClass('hidden');
                $('#' + calcId).removeClass('hidden');
            }

            // open modal on load
            $('.ui.modal')
                .modal({
                    closable: false,
                    onDeny: function () {
                        navToHomepage()
                        return true;
                    },
                    onApprove: function () {
                        return true;
                    },
                })
                .modal('show');
        </script>
    </body>
</html>
